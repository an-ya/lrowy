<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>文章</title>
    <meta name="renderer" content="webkit">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap">
    <link rel="stylesheet" href="/ckeditor-v4.12.1/plugins/codesnippet/lib/highlight/styles/vue.css?t=20191112">
    <script src="/ckeditor-v4.12.1/plugins/codesnippet/lib/highlight/highlight.pack.js"></script>
    <style>
        ul {
            margin: 0;
            padding: 0;
        }

        li {
            list-style: none;
        }

        .header {
            background: #fafafa;
            box-shadow: none;
        }

        .main {
            display: flex;
            justify-content: space-between;
        }

        .directory {
            display: block;
            border-left: 1px solid #eee;
        }

        .directory .h1 {
            padding: 8px 15px;
        }

        .directory .dir-body {
            position: relative;
            overflow: hidden;
        }

        .directory .dir-body .cursor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0;
            border-left: 2px solid #2979ff;
            background: rgba(41, 121, 255, .12);
            -webkit-transition: all .4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transition: all .4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .directory ul {
            line-height: 26px;
        }

        .directory li {
            position: relative;
            padding: 0 15px;
        }

        .directory li.active a {
            color: #3867d6;
        }

        .directory a {
            position: relative;
            display: block;
            color: #304455;
            line-height: 26px;
            text-decoration: none;
        }

        .directory a:hover {
            color: #2979ff;
        }

        .directory.none {
            display: none;
        }

        .level1 {margin-left: 15px;}
        .level1 a:after {position: absolute;content: '#';top: 0;left: -15px;}
        .level2 {margin-left: 30px;}
        .level2 a:after {position: absolute;content: '';top: 11px;left: -15px;width: 4px;height: 4px;border-radius: 50%;background: #304455;}
        .level3 {margin-left: 45px;}
        .level3 a:after {position: absolute;content: '';top: 11px;left: -15px;width: 4px;height: 4px;background: #304455;}
        .level4 {margin-left: 45px;}
        .level4 a:after {position: absolute;content: '';top: 11px;left: -15px;width: 4px;height: 4px;background: #304455;}
        .level5 {margin-left: 60px;}
        .level5 a:after {position: absolute;content: '';top: 11px;left: -15px;width: 4px;height: 4px;background: #304455;}
        .level6 {margin-left: 75px;}
        .level6 a:after {position: absolute;content: '';top: 11px;left: -15px;width: 4px;height: 4px;background: #304455;}
        .active .item a:after{background: #2979ff;}
        .level1 a:hover:after{color: #304455;}
        .active .level1 a:after{background: transparent;color: #2979ff;}

        .main {
            width: 946px;
            padding: 0;
            margin: 24px auto 0 auto;
        }

        .clear:after {
            content: '\0020';
            display: block;
            height: 0;
            clear: both;
            visibility: hidden;
        }

        .left-side {
            width: 656px;
            padding: 0 24px;
        }

        .right-side {
            width: 280px;
            margin-left: 10px;
        }

        .right-side .directory {
            position: sticky;
            top: 84px;
        }

        .right-side-copy {
            height: 0;
            overflow: hidden;
        }

        .md-ripple-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-clip: padding-box;
            pointer-events: none;
        }

        .md-ripple-container svg {
            position: absolute;
            fill: rgba(56, 103, 214, .12);
            -webkit-transition: all .4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transition: all .4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .article {
            padding: 1px 0;
        }

        .article_wrapper {
            overflow: hidden;
        }

        .about {
            position: relative;
            padding: 8px 15px;
        }

        .about i {
            position: absolute;
            top: 50%;
            left: 0;
            color: #fafafa;
            font-size: 60px;
            -webkit-transform: translateX(-50%) translateY(-50%);
            transform: translateX(-50%) translateY(-50%);
            z-index: -1;
        }

        .about .info .name {
            margin-bottom: 6px;
            font-size: 16px;
            font-weight: bold;
        }

        @media screen and (max-width: 960px) {
            .header {
                height: 50px;
            }

            .main {
                width: 100%;
            }

            .left-side {
                margin: 0 auto;
            }

            .right-side {
                display: none;
            }

            .right-side-copy {
                height: auto;
            }
        }

        @media screen and (max-width: 670px) {
            .left-side {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <ul class="header-menu">
        <li th:if="${user != null}" class="header-item">
            <button class="menu-button"><span>Menu</span></button>
        </li>
        <li th:if="${user == null}" class="header-item dropdown-content">
            <button class="login-button dropdown-trigger"><i class="iconfont">&#xe622;</i></button>
            <div class="dropdown hidden fixed">
                <ul class="dropdown-menu">
                    <li id="login" class="dropdown-item">登录</li>
                    <li  class="dropdown-item">注册</li>
                </ul>
            </div>
        </li>
    </ul>
</div>
<div class="header-space"></div>
<div class="sidebar">
    <div class="sidebar-inner">
        <div class="right-side-copy">
            <img style="width: 44px;height: 44px;border-radius: 50%;" src="https://www.lrowy.com//img/user/default.png"/>
            <div class="about">
                <i class="iconfont">&#xe636;</i>
                <div class="info">
                    <div class="name">黯伢</div>
                    <div class="desc">程序员</div>
                </div>
            </div>
            <div class="directory none"><div class="h1">目录</div><div class="dir-body"><div class="cursor"></div></div></div>
        </div>
    </div>
</div>
<div class="main clear">
    <div class="left-side">
        <div class="article_wrapper">
            <div class="article" id="article" th:utext="${article.content}" th:attr="data-article-id=${article.articleId}"></div>
        </div>
    </div>
    <div class="right-side">
        <img style="width: 44px;height: 44px;border-radius: 50%;" src="https://www.lrowy.com//img/user/default.png"/>
        <div class="about">
            <i class="iconfont">&#xe636;</i>
            <div class="info">
                <div class="name">黯伢</div>
                <div class="desc">程序员</div>
            </div>
        </div>
        <div class="directory none sticky" data-sticky-top="24" data-width="280">
            <div class="h1">目录</div>
            <div class="dir-body"><div class="cursor"></div></div>
        </div>
    </div>
</div>
<script>hljs.initHighlightingOnLoad();</script>
<script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.js"></script>
<script src="https://cdn.bootcss.com/lodash.js/4.17.15/lodash.min.js"></script>
<script th:src="@{/js/common.js}"></script>
<script th:src="@{/js/md-ripple.js}"></script>
<script>
    var page = $('html, body'), scrollTop, isScrolling = false, scrollCount = 0;
    var bash = decodeURIComponent(window.location.hash);
    var dirIndex = -1, showType, currentDir;
    var $header = $('.header');

    function setDirectory (resetFlag) {
        var dirString = '', num = 0, minLevel = 7;
        $('.article :header').each(function () {
            var $this = $(this);
            var contentH = $this.text().replace(/\s*/g, '');
            contentH = contentH.replace(/\./g, '-');
            var level = $this[0].tagName.substr(1,1);
            var hID = num + '-' + contentH;
            $this.attr('id', hID);
            hID = '##' + hID;

            dirString += '<li><div class="item level' + level + '"><a href="' + hID + '">' + contentH + '</a></div></li>';
            num += 1;
            if (level < minLevel) minLevel = level;
        });
        dirString = '<ul>' + dirString + '</ul>';
        if (num > 0) {
            if (resetFlag) {
                $('.directory .dir-body').html('<div class="cursor"></div>' + dirString);
            } else {
                $('.directory .dir-body').append(dirString);
            }
            $('.directory ul').css('margin-left', -(minLevel - 1) * 15 + 'px');
            $('.directory').removeClass('none');
            $('.directory .item').mdRipple();
            setAnchor();
            initCursor(bash);
        }
    }

    function set() {
        $('pre code').on('mousewheel DOMMouseScroll', function (e) {
            e.preventDefault();
            var wheel = e.originalEvent.wheelDelta || -e.originalEvent.detail;
            var delta = Math.max(-1, Math.min(1, wheel));
            var $this = $(this);
            console.log($this.scrollLeft());
            console.log($this[0].offsetWidth);
            if (delta < 0) {
                $this.scrollLeft($this.scrollLeft() + 50);
            } else {
                $this.scrollLeft($this.scrollLeft() - 50);
            }
        });
        // $("pre code").each(function(index,element) {
        //     element.onwheel = function(event){
        //         var table = $(element).parents("pre");
        //         var right = $(element).width()-table[0].offsetWidth;
        //         if (table.scrollLeft()<right&&event.deltaY>0) {
        //             //禁止事件默认行为（此处禁止鼠标滚轮行为关联到"屏幕滚动条上下移动"行为）
        //             event.preventDefault();
        //             var left = (table.scrollLeft() + 50);
        //             table.scrollLeft(left);
        //         }
        //         if (table.scrollLeft()>0&&event.deltaY<0) {
        //             //禁止事件默认行为（此处禁止鼠标滚轮行为关联到"屏幕滚动条上下移动"行为）
        //             event.preventDefault();
        //             var left = (table.scrollLeft() - 50);
        //             table.scrollLeft(left);
        //         }
        //     }
        // })
    }

    function pageTo (href) {
        var target, pattern = /##.+/;
        var limit = Math.round($(document).height() - $(window).height());
        if (href === '#') {
            target = 0;
        } else if (href === '##') {
            target = limit;
        } else if (pattern.test(href)) {
            var len = href.length, hash = href.lastIndexOf("#");
            var id = href.substr(hash, len - hash);
            var ele = $(id);
            if (ele.length === 0) return;
            target = ele.offset().top - 60;
            if (target > limit) target = limit;
        } else {
            return;
        }
        isScrolling = true;
        scrollCount++;
        page.stop().animate({scrollTop: target}, 600, function () {isScrolling = false;});
    }

    function setAnchor () {
        var a = $('a[href*="#"]');
        a.off('mousedown touchstart');
        a.on('mousedown touchstart', function () {
            var $this = $(this);
            var href = $this.attr('href'), index = $this.parents('li').prevAll().length;
            setCursor(index, currentDir);
            $this.on('mouseup mouseleave touchend', function () {
                pageTo(href);
                window.location.hash = href;
                $this.off('mouseup mouseleave touchend');
            });
        });
    }

    function setCursor (index, dir) {
        var top = 0, li = dir.find('ul').children().eq(index);
        if (index < 0) {
            dir.find('.cursor').css({'top': 0, 'height': 0, 'border': 'none'});
            dir.find('li').removeClass('active');
        } else {
            li.prevAll().each(function () {top += $(this).height();});
            dir.find('.cursor').css({'top': top, 'height': li.height(), 'border': ''});
            dir.find('li').removeClass('active');
            li.addClass('active');
        }
        dirIndex = index;
    }

    function initCursor (href) {
        $('a[href*="#"]').each(function () {
            var $this = $(this), ref = $this.attr('href');
            if (ref === href) {
                var index = $this.parents('li').prevAll().length;
                setCursor(index, currentDir);
            }
        });
    }

    // 常规判断方法
    function setResize () {
        var h = $header.height();
        if (h === 60) {
            currentDir = $('.right-side .dir-body');
            if (showType === 0) setCursor(dirIndex, currentDir);
            showType = 1;
        } else {
            currentDir = $('.right-side-copy .dir-body');
            if (showType === 1) setCursor(dirIndex, currentDir);
            showType = 0;
        }
    }

    // 设置监听器判断方法
    function setResizeObserver() {
        var observer = new ResizeObserver(function (entries) {
            if (entries[0].contentRect.height > 0) {
                currentDir = $('.right-side .dir-body');
                setCursor(dirIndex, currentDir);
            } else {
                currentDir = $('.right-side-copy .dir-body');
                setCursor(dirIndex, currentDir);
            }
        });
        observer.observe($('.right-side .dir-body')[0]);
    }

    function scrollEvent () {
        scrollTop = $(this).scrollTop();
        if (isScrolling) return;
        if (scrollCount > 0) {scrollCount--;return;}

        var target = false;
        $('.article :header').each(function () {
           if (scrollTop + 61 >= $(this).offset().top) {
               initCursor('##' + $(this).attr('id'));
               target = true;
           }
        });
        if (!target) {setCursor(-1, currentDir);}
    }

    function setArticle (id, html) {
        var $article = $('#article');
        var $wrapper = $('.article_wrapper');
        if (id === $article.data('articleId')) {
            $wrapper.height($article.height());
            $('#article').html(html);
            hljs.highlightBlock($article[0]);
            setDirectory(true);
            $wrapper.height($article.height());
            pageTo('##');
        }
    }

    setResize();
    $(window).resize(setResize);
    // lodash throttle常用于防止事件在短时间内触发极多次，如ios上的滚轮事件，文本输入框change事件。
    $(window).scroll(_.throttle(scrollEvent, 100));
    $(document).ready(function () {
        setDirectory();
        set();
        pageTo(bash);
    });
</script>
</body>
</html>